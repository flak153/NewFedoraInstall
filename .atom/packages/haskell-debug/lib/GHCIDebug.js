"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const atomAPI = require("atom");
const ahu = require("atom-haskell-utils");
const interactive_process_1 = require("./interactive-process");
const os_1 = require("os");
class GHCIDebug {
    constructor(ghciCommand = 'ghci', ghciArgs = [], bufferPath) {
        this.emitter = new atomAPI.Emitter();
        this.on = this.emitter.on.bind(this.emitter);
        this.moduleNameByPath = new Map();
        this.addReadyEvent();
        this.readyPromise = this.init(ghciCommand, ghciArgs, bufferPath);
        this.readyPromise.then((response) => {
            console.warn(response.stderr.join(os_1.EOL));
        });
    }
    destroy() {
        this.stop();
    }
    async loadModule(name) {
        await this.run(`:load ${name}`);
    }
    async setExceptionBreakLevel(level) {
        await this.run(':unset -fbreak-on-exception', false, false, false, false);
        await this.run(':unset -fbreak-on-error', false, false, false, false);
        switch (level) {
            case 'exceptions':
                await this.run(':set -fbreak-on-exception', false, false, false, false);
                break;
            case 'errors':
                await this.run(':set -fbreak-on-error', false, false, false, false);
                break;
            case 'none':
                break;
        }
    }
    async addBreakpoint(breakpoint) {
        if (typeof breakpoint === 'string') {
            await this.run(`:break ${breakpoint}`);
        }
        else if (breakpoint.file) {
            try {
                const moduleName = await this.moduleNameFromFilePath(breakpoint.file);
                await this.run(`:break ${moduleName} ${breakpoint.line}`);
            }
            catch (e) {
                atom.notifications.addError(`Failed to set breakpoint on ${breakpoint.file}`, {
                    detail: e.toString(),
                    stack: e.stack,
                    dismissable: true,
                });
            }
        }
        else {
            atom.notifications.addError('Failed to set breakpoint', {
                detail: 'Text editor has no filename',
                dismissable: true,
            });
        }
    }
    async resolveExpression(expression) {
        if (!expression.trim()) {
            return undefined;
        }
        if (expression.indexOf('\n') !== -1) {
            return undefined;
        }
        const getExpression = (ghciOutput) => {
            const matchResult = ghciOutput.match(/[^ ]* = (.*)/);
            if (!matchResult) {
                return undefined;
            }
            return matchResult[1];
        };
        const printingResult = getExpression(await this.run(`:print ${expression}`, false, false, false, false));
        if (printingResult !== undefined) {
            return printingResult;
        }
        let tempVarNum = 0;
        let potentialTempVar;
        do {
            tempVarNum += 1;
            potentialTempVar = getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false, false));
        } while (potentialTempVar !== undefined);
        await this.run(`let temp${tempVarNum} = ${expression}`, false, false, false, false);
        return getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false, false));
    }
    forward() {
        this.run(':forward', true);
    }
    back() {
        this.run(':back', true);
    }
    step() {
        this.run(':step', true, true);
    }
    stop() {
        this.run(':quit');
        setTimeout(() => {
            this.process && this.process.destroy();
        }, 3000);
    }
    continue() {
        this.run(':continue', true);
    }
    async addedAllListeners() {
        return this.readyPromise;
    }
    async startDebug(moduleName) {
        moduleName = moduleName || 'main';
        await this.run(':trace ' + moduleName, true, true);
    }
    async run(commandText, emitStatusChanges = false, emitHistoryLength = false, emitCommandOutput = true, emitErrors = true) {
        await this.readyPromise;
        if (!this.process)
            throw new Error('No interactive process');
        let prompt = '';
        let tail = '';
        const response = await this.process.request(commandText + os_1.EOL, (arg) => {
            if (arg.type === 'stdin') {
                if (emitCommandOutput)
                    this.emitter.emit('command-issued', arg.line);
            }
            else if (arg.type === 'prompt') {
                tail = arg.prompt[1];
                prompt = arg.prompt[2];
                if (emitCommandOutput)
                    this.emitter.emit('console-output', `${tail}${prompt}> `);
            }
            else if (arg.type === 'stdout') {
                if (emitCommandOutput)
                    this.emitter.emit('console-output', arg.line + os_1.EOL);
            }
            else if (arg.type === 'stderr') {
                if (emitErrors)
                    this.emitter.emit('error', arg.line + os_1.EOL);
            }
        });
        const result = response.stdout;
        const err = response.stderr;
        if (tail)
            result.push(tail);
        if (emitErrors && err.length)
            this.emitter.emit('error-completed', err.join(os_1.EOL));
        if (emitStatusChanges) {
            await this.emitStatusChanges(prompt, result.join(os_1.EOL), emitHistoryLength);
        }
        return result.join(os_1.EOL);
    }
    async init(ghciCommand = 'ghci', ghciArgs = [], bufferPath) {
        const cwd = (await ahu.getRootDir(bufferPath || null)).getPath();
        this.process = new interactive_process_1.InteractiveProcess(ghciCommand, ghciArgs, () => { this.emitter.emit('debug-finished', undefined); }, { cwd, shell: true }, /^(.*)#~IDEHASKELLREPL~(.*)~#$/);
        return this.process.request(`:set prompt2 \"\"${os_1.EOL}` +
            `:set prompt-cont \"\"${os_1.EOL}` +
            `:set prompt \"#~IDEHASKELLREPL~%s~#\\n\"${os_1.EOL}`, (arg) => {
            if (arg.type === 'stdout') {
                this.emitter.emit('console-output', arg.line + os_1.EOL);
            }
            else if (arg.type === 'stderr') {
                this.emitter.emit('error', arg.line + os_1.EOL);
            }
            else if (arg.type === 'prompt') {
                this.emitter.emit('console-output', `${arg.prompt[1]}${arg.prompt[2]}> `);
            }
        });
    }
    addReadyEvent() {
        this.emitter.on('paused-on-exception', () => this.emitter.emit('ready', undefined));
        this.emitter.on('line-changed', () => this.emitter.emit('ready', undefined));
        this.emitter.on('debug-finished', () => this.emitter.emit('ready', undefined));
    }
    async getBindings() {
        const outputStr = await this.run(':show bindings', false, false, false);
        return outputStr.split(os.EOL);
    }
    async getHistoryLength() {
        const historyQuery = await this.run(':history 100', false, false, false);
        const regex = /-(\d*).*(?:\n|\r|\r\n)<end of history>$/;
        const matchResult = historyQuery.match(regex);
        if (!matchResult) {
            if (historyQuery.slice(-3) === '...') {
                return Infinity;
            }
            else {
                return 0;
            }
        }
        else {
            return parseInt(matchResult[1], 10);
        }
    }
    parsePrompt(stdOutput) {
        const patterns = [{
                pattern: /^\[(?:[-\d]*: )?(.*):\((\d+),(\d+)\)-\((\d+),(\d+)\).*\].*$/,
                func: (match) => ({
                    filename: match[1],
                    range: [[parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[4], 10), parseInt(match[5], 10)]],
                }),
            }, {
                pattern: /^\[(?:[-\d]*: )?(.*):(\d*):(\d*)-(\d*)\].*$/,
                func: (match) => ({
                    filename: match[1],
                    range: [[parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[2], 10) - 1, parseInt(match[4], 10)]],
                }),
            }, {
                pattern: /^\[<exception thrown>\].*$/,
                func: () => GHCIDebug.pausedOnError,
            }, {
                pattern: /^.*$/,
                func: () => GHCIDebug.finishedDebugging,
            }];
        for (const pattern of patterns) {
            const matchResult = stdOutput.match(pattern.pattern);
            if (matchResult) {
                return pattern.func(matchResult);
            }
        }
        throw new Error('Cannot read prompt: \n' + stdOutput);
    }
    async emitStatusChanges(prompt, mainBody, emitHistoryLength) {
        const result = this.parsePrompt(prompt);
        if (result === GHCIDebug.pausedOnError) {
            const historyLength = await this.getHistoryLength();
            this.emitter.emit('paused-on-exception', {
                historyLength,
                localBindings: mainBody.split('\n').slice(1),
            });
        }
        else if (result === GHCIDebug.finishedDebugging) {
            this.emitter.emit('debug-finished', undefined);
        }
        else {
            const breakInfo = result;
            breakInfo.localBindings = await this.getBindings();
            if (emitHistoryLength) {
                breakInfo.historyLength = await this.getHistoryLength();
            }
            this.emitter.emit('line-changed', breakInfo);
        }
    }
    async moduleNameFromFilePath(filePath) {
        const cachedModuleName = this.moduleNameByPath.get(filePath);
        if (cachedModuleName)
            return cachedModuleName;
        const modules = (await this.run(':show modules')).split(os.EOL);
        const regex = /^([^ ]+) +\( +(.+), +\w+ +\)$/;
        for (const moduleStr of modules) {
            const matchResult = regex.exec(moduleStr);
            if (matchResult) {
                this.moduleNameByPath.set(matchResult[2], matchResult[1]);
            }
            else {
                console.error(`Unexpected reply from GHCI ':show modules': ${moduleStr}`);
            }
        }
        const newCachedModuleName = this.moduleNameByPath.get(filePath);
        if (newCachedModuleName) {
            return newCachedModuleName;
        }
        else {
            throw new Error(`Couldn't find module name for ${filePath}`);
        }
    }
}
GHCIDebug.pausedOnError = Symbol('Paused on Error');
GHCIDebug.finishedDebugging = Symbol('Finished debugging');
exports.GHCIDebug = GHCIDebug;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR0hDSURlYnVnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xpYi9HSENJRGVidWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBeUI7QUFDekIsZ0NBQWdDO0FBQ2hDLDBDQUF5QztBQUN6QywrREFBMEU7QUFDMUUsMkJBQXdCO0FBcUJ4QjtJQXNCRSxZQUFZLFdBQVcsR0FBRyxNQUFNLEVBQUUsV0FBcUIsRUFBRSxFQUFFLFVBQW1CO1FBbEJ0RSxZQUFPLEdBVVYsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUE7UUFFVixPQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUkvQyxxQkFBZ0IsR0FBd0IsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUd2RCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDcEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUE7UUFFaEUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUNsQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQUcsQ0FBQyxDQUFDLENBQUE7UUFDekMsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUNiLENBQUM7SUFFTSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQVk7UUFDbEMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUNqQyxDQUFDO0lBRU0sS0FBSyxDQUFDLHNCQUFzQixDQUFDLEtBQTJCO1FBQzdELE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN6RSxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFckUsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNkLEtBQUssWUFBWTtnQkFDZixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7Z0JBQ3ZFLEtBQUssQ0FBQTtZQUNQLEtBQUssUUFBUTtnQkFDWCxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7Z0JBQ25FLEtBQUssQ0FBQTtZQUNQLEtBQUssTUFBTTtnQkFDVCxLQUFLLENBQUE7UUFDVCxDQUFDO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxhQUFhLENBQUMsVUFBK0I7UUFDeEQsRUFBRSxDQUFDLENBQUMsT0FBTyxVQUFVLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBQ3hDLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDO2dCQUNILE1BQU0sVUFBVSxHQUFXLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDN0UsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsVUFBVSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQzNELENBQUM7WUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNYLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLCtCQUErQixVQUFVLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQzVFLE1BQU0sRUFBRyxDQUFXLENBQUMsUUFBUSxFQUFFO29CQUMvQixLQUFLLEVBQUcsQ0FBVyxDQUFDLEtBQUs7b0JBQ3pCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7WUFDSixDQUFDO1FBQ0gsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsMEJBQTBCLEVBQUU7Z0JBQ3RELE1BQU0sRUFBRSw2QkFBNkI7Z0JBQ3JDLFdBQVcsRUFBRSxJQUFJO2FBQ2xCLENBQUMsQ0FBQTtRQUNKLENBQUM7SUFDSCxDQUFDO0lBSU0sS0FBSyxDQUFDLGlCQUFpQixDQUFDLFVBQWtCO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN2QixNQUFNLENBQUMsU0FBUyxDQUFBO1FBQ2xCLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsU0FBUyxDQUFBO1FBQ2xCLENBQUM7UUFFRCxNQUFNLGFBQWEsR0FBRyxDQUFDLFVBQWtCLEVBQUUsRUFBRTtZQUMzQyxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFBO1lBQ3BELEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFBQyxNQUFNLENBQUMsU0FBUyxDQUFBO1lBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3ZCLENBQUMsQ0FBQTtRQUtELE1BQU0sY0FBYyxHQUFHLGFBQWEsQ0FDbEMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsVUFBVSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNyRSxFQUFFLENBQUMsQ0FBQyxjQUFjLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNqQyxNQUFNLENBQUMsY0FBYyxDQUFBO1FBQ3ZCLENBQUM7UUFHRCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUE7UUFDbEIsSUFBSSxnQkFBb0MsQ0FBQTtRQUN4QyxHQUFHLENBQUM7WUFDRixVQUFVLElBQUksQ0FBQyxDQUFBO1lBQ2YsZ0JBQWdCLEdBQUcsYUFBYSxDQUM5QixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsY0FBYyxVQUFVLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQzNFLENBQUMsUUFBUSxnQkFBZ0IsS0FBSyxTQUFTLEVBQUM7UUFFeEMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsVUFBVSxNQUFNLFVBQVUsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ25GLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsVUFBVSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUM5RixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQzVCLENBQUM7SUFFTSxJQUFJO1FBQ1QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDekIsQ0FBQztJQUVNLElBQUk7UUFDVCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVNLElBQUk7UUFDVCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2pCLFVBQVUsQ0FDUixHQUFHLEVBQUU7WUFDSCxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDeEMsQ0FBQyxFQUNELElBQUksQ0FBQyxDQUFBO0lBQ1QsQ0FBQztJQUVNLFFBQVE7UUFDYixJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUM3QixDQUFDO0lBRU0sS0FBSyxDQUFDLGlCQUFpQjtRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQTtJQUMxQixDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFtQjtRQUN6QyxVQUFVLEdBQUcsVUFBVSxJQUFJLE1BQU0sQ0FBQTtRQUNqQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDcEQsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQ2QsV0FBbUIsRUFDbkIsb0JBQTZCLEtBQUssRUFDbEMsb0JBQTZCLEtBQUssRUFDbEMsb0JBQTZCLElBQUksRUFDakMsYUFBc0IsSUFBSTtRQUUxQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUE7UUFDdkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO1FBQzVELElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUNmLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUViLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxHQUFHLFFBQUcsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3JFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDekIsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUM7b0JBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3RFLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxJQUFJLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDcEIsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO29CQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUE7WUFDbEYsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO29CQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxJQUFJLEdBQUcsUUFBRyxDQUFDLENBQUE7WUFDNUUsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQztvQkFBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksR0FBRyxRQUFHLENBQUMsQ0FBQTtZQUM1RCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFBO1FBQzlCLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUE7UUFFM0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUUzQixFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBRyxDQUFDLENBQUMsQ0FBQTtRQUVqRixFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQzFCLE1BQU0sRUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQUcsQ0FBQyxFQUNoQixpQkFBaUIsQ0FDbEIsQ0FBQTtRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFHLENBQUMsQ0FBQTtJQUN6QixDQUFDO0lBRU8sS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxFQUFFLFdBQXFCLEVBQUUsRUFBRSxVQUFtQjtRQUVuRixNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLFVBQVUsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUNoRSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksd0NBQWtCLENBQ25DLFdBQVcsRUFBRSxRQUFRLEVBQ3JCLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFBLENBQUMsQ0FBQyxFQUN4RCxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQ3BCLCtCQUErQixDQUNoQyxDQUFBO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUN6QixvQkFBb0IsUUFBRyxFQUFFO1lBQ3pCLHdCQUF3QixRQUFHLEVBQUU7WUFDN0IsMkNBQTJDLFFBQUcsRUFBRSxFQUNoRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBRU4sRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsSUFBSSxHQUFHLFFBQUcsQ0FBQyxDQUFBO1lBRXJELENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksR0FBRyxRQUFHLENBQUMsQ0FBQTtZQUU1QyxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQzNFLENBQUM7UUFDSCxDQUFDLENBQ0YsQ0FBQTtJQUNILENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQ25GLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUM1RSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQTtJQUNoRixDQUFDO0lBRU8sS0FBSyxDQUFDLFdBQVc7UUFDdkIsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDdkUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ2hDLENBQUM7SUFFTyxLQUFLLENBQUMsZ0JBQWdCO1FBQzVCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN4RSxNQUFNLEtBQUssR0FBRyx5Q0FBeUMsQ0FBQTtRQUV2RCxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQzdDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUNqQixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDckMsTUFBTSxDQUFDLFFBQVEsQ0FBQTtZQUNqQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLENBQUMsQ0FBQTtZQUNWLENBQUM7UUFDSCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyQyxDQUFDO0lBQ0gsQ0FBQztJQUVPLFdBQVcsQ0FBQyxTQUFpQjtRQUNuQyxNQUFNLFFBQVEsR0FBRyxDQUFDO2dCQUNoQixPQUFPLEVBQUUsNkRBQTZEO2dCQUN0RSxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ2hCLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO29CQUNsQixLQUFLLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUNoRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUNsRCxDQUFDO2FBQ0gsRUFBRTtnQkFDRCxPQUFPLEVBQUUsNkNBQTZDO2dCQUN0RCxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ2hCLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO29CQUNsQixLQUFLLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUNoRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDdEQsQ0FBQzthQUNILEVBQUU7Z0JBQ0QsT0FBTyxFQUFFLDRCQUE0QjtnQkFDckMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxhQUFhO2FBQ3BDLEVBQUU7Z0JBQ0QsT0FBTyxFQUFFLE1BQU07Z0JBQ2YsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUI7YUFDeEMsQ0FBOEUsQ0FBQTtRQUMvRSxHQUFHLENBQUMsQ0FBQyxNQUFNLE9BQU8sSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3BELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBQ2xDLENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsR0FBRyxTQUFTLENBQUMsQ0FBQTtJQUN2RCxDQUFDO0lBRU8sS0FBSyxDQUFDLGlCQUFpQixDQUFDLE1BQWMsRUFBRSxRQUFnQixFQUFFLGlCQUEwQjtRQUMxRixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRXZDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUN2QyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1lBRW5ELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO2dCQUN2QyxhQUFhO2dCQUNiLGFBQWEsRUFBRSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7YUFDN0MsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLENBQUMsQ0FBQTtRQUNoRCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLFNBQVMsR0FBRyxNQUFtQixDQUFBO1lBRXJDLFNBQVMsQ0FBQyxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7WUFFbEQsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixTQUFTLENBQUMsYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUE7WUFDekQsQ0FBQztZQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQTtRQUM5QyxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxRQUFnQjtRQUNuRCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDNUQsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUM7WUFBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUE7UUFDN0MsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQy9ELE1BQU0sS0FBSyxHQUFHLCtCQUErQixDQUFBO1FBQzdDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sU0FBUyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUN6QyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUMzRCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sT0FBTyxDQUFDLEtBQUssQ0FBQywrQ0FBK0MsU0FBUyxFQUFFLENBQUMsQ0FBQTtZQUMzRSxDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUMvRCxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLG1CQUFtQixDQUFBO1FBQzVCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFDOUQsQ0FBQztJQUNILENBQUM7O0FBblVjLHVCQUFhLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7QUFDekMsMkJBQWlCLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUE7QUFGakUsOEJBcVVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKVxuaW1wb3J0IGF0b21BUEkgPSByZXF1aXJlKCdhdG9tJylcbmltcG9ydCAqIGFzIGFodSBmcm9tICdhdG9tLWhhc2tlbGwtdXRpbHMnXG5pbXBvcnQgeyBJbnRlcmFjdGl2ZVByb2Nlc3MsIElSZXF1ZXN0UmVzdWx0IH0gZnJvbSAnLi9pbnRlcmFjdGl2ZS1wcm9jZXNzJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQnJlYWtJbmZvIHtcbiAgZmlsZW5hbWU6IHN0cmluZ1xuICByYW5nZTogW1tudW1iZXIsIG51bWJlcl0sIFtudW1iZXIsIG51bWJlcl1dXG4gIGhpc3RvcnlMZW5ndGg/OiBudW1iZXJcbiAgbG9jYWxCaW5kaW5nczogc3RyaW5nW11cbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeGNlcHRpb25JbmZvIHtcbiAgaGlzdG9yeUxlbmd0aDogbnVtYmVyXG4gIGxvY2FsQmluZGluZ3M6IHN0cmluZ1tdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnJlYWtwb2ludCB7XG4gIGxpbmU6IG51bWJlciAvLyAxIGlzIHRoZSBncmVhdGVzdCBudW1iZXIgdGhpcyBjYW4gY29udGFpblxuICBmaWxlOiBzdHJpbmcgfCB1bmRlZmluZWQgLy8gYWJzb2x1dGUgcGF0aFxufVxuXG5leHBvcnQgdHlwZSBFeGNlcHRpb25CcmVha0xldmVscyA9ICdub25lJyB8ICdleGNlcHRpb25zJyB8ICdlcnJvcnMnXG5cbmV4cG9ydCBjbGFzcyBHSENJRGVidWcge1xuICBwcml2YXRlIHN0YXRpYyBwYXVzZWRPbkVycm9yID0gU3ltYm9sKCdQYXVzZWQgb24gRXJyb3InKVxuICBwcml2YXRlIHN0YXRpYyBmaW5pc2hlZERlYnVnZ2luZyA9IFN5bWJvbCgnRmluaXNoZWQgZGVidWdnaW5nJylcblxuICBwcml2YXRlIGVtaXR0ZXI6IGF0b21BUEkuRW1pdHRlcjx7XG4gICAgJ2RlYnVnLWZpbmlzaGVkJzogdW5kZWZpbmVkIC8vLyBFbW1pdGVkIHdoZW4gdGhlIGRlYnVnZ2VyIGhhcyByZWFjaGVkIHRoZSBlbmQgb2YgdGhlIHByb2dyYW1cbiAgICAncmVhZHknOiBFeGNlcHRpb25JbmZvIHwgdW5kZWZpbmVkIC8vLyBFbW1pdGVkIHdoZW4gZ2hjaSBoYXMganVzdCBzdG9wcGVkIGV4ZWN1dGluZyBhIGNvbW1hbmRcbiAgfSwge1xuICAgICdwYXVzZWQtb24tZXhjZXB0aW9uJzogRXhjZXB0aW9uSW5mbyAvLy8gRW1taXRlZCB3aGVuIHRoZSBkZWJ1Z2dlciBpcyBhdCBhbiBleGNlcHRpb25cbiAgICAnZXJyb3InOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiBzdGRlcnIgaGFzIGlucHV0XG4gICAgJ2Vycm9yLWNvbXBsZXRlZCc6IHN0cmluZyAvLy8gRW1taXRlZCB3aGVuIGdoY2kgcmVwb3J0cyBhbiBlcnJvciBmb3IgYSBnaXZlbiBjb21tYW5kXG4gICAgJ2xpbmUtY2hhbmdlZCc6IEJyZWFrSW5mbyAvLy8gRW1taXRlZCB3aGVuIHRoZSBsaW5lIHRoYXQgdGhlIGRlYnVnZ2VyIGlzIG9uIGNoYW5nZXNcbiAgICAnY29uc29sZS1vdXRwdXQnOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiB0aGUgZ2hjaSBoYXMgb3V0cHV0ZWQgc29tZXRoaW5nIHRvIHN0ZG91dCwgZXhjbHVkaW5nIHRoZSBleHRyYSBwcm9tcHRcbiAgICAnY29tbWFuZC1pc3N1ZWQnOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiBhIGNvbW1hbmQgaGFzIGJlZW4gZXhlY3V0ZWRcbiAgfT4gPSBuZXcgYXRvbUFQSS5FbWl0dGVyKClcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtZW1iZXItb3JkZXJpbmdcbiAgcHVibGljIHJlYWRvbmx5IG9uID0gdGhpcy5lbWl0dGVyLm9uLmJpbmQodGhpcy5lbWl0dGVyKVxuXG4gIHByaXZhdGUgcHJvY2Vzcz86IEludGVyYWN0aXZlUHJvY2Vzc1xuICBwcml2YXRlIHJlYWR5UHJvbWlzZTogUHJvbWlzZTxJUmVxdWVzdFJlc3VsdD5cbiAgcHJpdmF0ZSBtb2R1bGVOYW1lQnlQYXRoOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpXG5cbiAgY29uc3RydWN0b3IoZ2hjaUNvbW1hbmQgPSAnZ2hjaScsIGdoY2lBcmdzOiBzdHJpbmdbXSA9IFtdLCBidWZmZXJQYXRoPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRSZWFkeUV2ZW50KClcbiAgICB0aGlzLnJlYWR5UHJvbWlzZSA9IHRoaXMuaW5pdChnaGNpQ29tbWFuZCwgZ2hjaUFyZ3MsIGJ1ZmZlclBhdGgpXG5cbiAgICB0aGlzLnJlYWR5UHJvbWlzZS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgY29uc29sZS53YXJuKHJlc3BvbnNlLnN0ZGVyci5qb2luKEVPTCkpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuc3RvcCgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbG9hZE1vZHVsZShuYW1lOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLnJ1bihgOmxvYWQgJHtuYW1lfWApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2V0RXhjZXB0aW9uQnJlYWtMZXZlbChsZXZlbDogRXhjZXB0aW9uQnJlYWtMZXZlbHMpIHtcbiAgICBhd2FpdCB0aGlzLnJ1bignOnVuc2V0IC1mYnJlYWstb24tZXhjZXB0aW9uJywgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpXG4gICAgYXdhaXQgdGhpcy5ydW4oJzp1bnNldCAtZmJyZWFrLW9uLWVycm9yJywgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpXG5cbiAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICBjYXNlICdleGNlcHRpb25zJzpcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oJzpzZXQgLWZicmVhay1vbi1leGNlcHRpb24nLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2Vycm9ycyc6XG4gICAgICAgIGF3YWl0IHRoaXMucnVuKCc6c2V0IC1mYnJlYWstb24tZXJyb3InLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ25vbmUnOiAvLyBuby1vcFxuICAgICAgICBicmVha1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhZGRCcmVha3BvaW50KGJyZWFrcG9pbnQ6IEJyZWFrcG9pbnQgfCBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodHlwZW9mIGJyZWFrcG9pbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBhd2FpdCB0aGlzLnJ1bihgOmJyZWFrICR7YnJlYWtwb2ludH1gKVxuICAgIH0gZWxzZSBpZiAoYnJlYWtwb2ludC5maWxlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBtb2R1bGVOYW1lOiBzdHJpbmcgPSBhd2FpdCB0aGlzLm1vZHVsZU5hbWVGcm9tRmlsZVBhdGgoYnJlYWtwb2ludC5maWxlKVxuICAgICAgICBhd2FpdCB0aGlzLnJ1bihgOmJyZWFrICR7bW9kdWxlTmFtZX0gJHticmVha3BvaW50LmxpbmV9YClcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGBGYWlsZWQgdG8gc2V0IGJyZWFrcG9pbnQgb24gJHticmVha3BvaW50LmZpbGV9YCwge1xuICAgICAgICAgIGRldGFpbDogKGUgYXMgRXJyb3IpLnRvU3RyaW5nKCksXG4gICAgICAgICAgc3RhY2s6IChlIGFzIEVycm9yKS5zdGFjayxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdGYWlsZWQgdG8gc2V0IGJyZWFrcG9pbnQnLCB7XG4gICAgICAgIGRldGFpbDogJ1RleHQgZWRpdG9yIGhhcyBubyBmaWxlbmFtZScsXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICAvKiogcmVzb2x2ZWQgdGhlIGdpdmVuIGV4cHJlc3Npb24gdXNpbmcgOnByaW50LCByZXR1cm5zIG51bGwgaWYgaXQgaXMgaW52YWxpZFxuICAqL1xuICBwdWJsaWMgYXN5bmMgcmVzb2x2ZUV4cHJlc3Npb24oZXhwcmVzc2lvbjogc3RyaW5nKSB7XG4gICAgaWYgKCFleHByZXNzaW9uLnRyaW0oKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICAvLyBleHByZXNzaW9ucyBjYW4ndCBoYXZlIG5ldyBsaW5lc1xuICAgIGlmIChleHByZXNzaW9uLmluZGV4T2YoJ1xcbicpICE9PSAtMSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGNvbnN0IGdldEV4cHJlc3Npb24gPSAoZ2hjaU91dHB1dDogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBtYXRjaFJlc3VsdCA9IGdoY2lPdXRwdXQubWF0Y2goL1teIF0qID0gKC4qKS8pXG4gICAgICBpZiAoIW1hdGNoUmVzdWx0KSB7IHJldHVybiB1bmRlZmluZWQgfVxuICAgICAgcmV0dXJuIG1hdGNoUmVzdWx0WzFdXG4gICAgfVxuXG4gICAgLy8gVE9ETzogZm9yIHRoZSBjb2RlIGJlbG93LCBpZ25vcmUgZXJyb3JzXG5cbiAgICAvLyB0cnkgcHJpbnRpbmcgZXhwcmVzc2lvblxuICAgIGNvbnN0IHByaW50aW5nUmVzdWx0ID0gZ2V0RXhwcmVzc2lvbihcbiAgICAgIGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgJHtleHByZXNzaW9ufWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKSlcbiAgICBpZiAocHJpbnRpbmdSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHByaW50aW5nUmVzdWx0XG4gICAgfVxuXG4gICAgLy8gaWYgdGhhdCBmYWlscyBhc3NpZ24gaXQgdG8gYSB0ZW1wb3JhcnkgdmFyaWFibGUgYW5kIGV2YWx1YXRlIHRoYXRcbiAgICBsZXQgdGVtcFZhck51bSA9IDBcbiAgICBsZXQgcG90ZW50aWFsVGVtcFZhcjogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgZG8ge1xuICAgICAgdGVtcFZhck51bSArPSAxXG4gICAgICBwb3RlbnRpYWxUZW1wVmFyID0gZ2V0RXhwcmVzc2lvbihcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oYDpwcmludCB0ZW1wJHt0ZW1wVmFyTnVtfWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKSlcbiAgICB9IHdoaWxlIChwb3RlbnRpYWxUZW1wVmFyICE9PSB1bmRlZmluZWQpXG5cbiAgICBhd2FpdCB0aGlzLnJ1bihgbGV0IHRlbXAke3RlbXBWYXJOdW19ID0gJHtleHByZXNzaW9ufWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgIHJldHVybiBnZXRFeHByZXNzaW9uKGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgdGVtcCR7dGVtcFZhck51bX1gLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSkpXG4gIH1cblxuICBwdWJsaWMgZm9yd2FyZCgpIHtcbiAgICB0aGlzLnJ1bignOmZvcndhcmQnLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIGJhY2soKSB7XG4gICAgdGhpcy5ydW4oJzpiYWNrJywgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBzdGVwKCkge1xuICAgIHRoaXMucnVuKCc6c3RlcCcsIHRydWUsIHRydWUpXG4gIH1cblxuICBwdWJsaWMgc3RvcCgpIHtcbiAgICB0aGlzLnJ1bignOnF1aXQnKVxuICAgIHNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvY2VzcyAmJiB0aGlzLnByb2Nlc3MuZGVzdHJveSgpXG4gICAgICB9LFxuICAgICAgMzAwMClcbiAgfVxuXG4gIHB1YmxpYyBjb250aW51ZSgpIHtcbiAgICB0aGlzLnJ1bignOmNvbnRpbnVlJywgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhZGRlZEFsbExpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVByb21pc2VcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzdGFydERlYnVnKG1vZHVsZU5hbWU/OiBzdHJpbmcpIHtcbiAgICBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZSB8fCAnbWFpbidcbiAgICBhd2FpdCB0aGlzLnJ1bignOnRyYWNlICcgKyBtb2R1bGVOYW1lLCB0cnVlLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJ1bihcbiAgICBjb21tYW5kVGV4dDogc3RyaW5nLFxuICAgIGVtaXRTdGF0dXNDaGFuZ2VzOiBib29sZWFuID0gZmFsc2UsXG4gICAgZW1pdEhpc3RvcnlMZW5ndGg6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBlbWl0Q29tbWFuZE91dHB1dDogYm9vbGVhbiA9IHRydWUsXG4gICAgZW1pdEVycm9yczogYm9vbGVhbiA9IHRydWUsXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgYXdhaXQgdGhpcy5yZWFkeVByb21pc2VcbiAgICBpZiAoIXRoaXMucHJvY2VzcykgdGhyb3cgbmV3IEVycm9yKCdObyBpbnRlcmFjdGl2ZSBwcm9jZXNzJylcbiAgICBsZXQgcHJvbXB0ID0gJydcbiAgICBsZXQgdGFpbCA9ICcnXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMucHJvY2Vzcy5yZXF1ZXN0KGNvbW1hbmRUZXh0ICsgRU9MLCAoYXJnKSA9PiB7XG4gICAgICBpZiAoYXJnLnR5cGUgPT09ICdzdGRpbicpIHtcbiAgICAgICAgaWYgKGVtaXRDb21tYW5kT3V0cHV0KSB0aGlzLmVtaXR0ZXIuZW1pdCgnY29tbWFuZC1pc3N1ZWQnLCBhcmcubGluZSlcbiAgICAgIH0gZWxzZSBpZiAoYXJnLnR5cGUgPT09ICdwcm9tcHQnKSB7XG4gICAgICAgIHRhaWwgPSBhcmcucHJvbXB0WzFdXG4gICAgICAgIHByb21wdCA9IGFyZy5wcm9tcHRbMl1cbiAgICAgICAgaWYgKGVtaXRDb21tYW5kT3V0cHV0KSB0aGlzLmVtaXR0ZXIuZW1pdCgnY29uc29sZS1vdXRwdXQnLCBgJHt0YWlsfSR7cHJvbXB0fT4gYClcbiAgICAgIH0gZWxzZSBpZiAoYXJnLnR5cGUgPT09ICdzdGRvdXQnKSB7XG4gICAgICAgIGlmIChlbWl0Q29tbWFuZE91dHB1dCkgdGhpcy5lbWl0dGVyLmVtaXQoJ2NvbnNvbGUtb3V0cHV0JywgYXJnLmxpbmUgKyBFT0wpXG4gICAgICB9IGVsc2UgaWYgKGFyZy50eXBlID09PSAnc3RkZXJyJykge1xuICAgICAgICBpZiAoZW1pdEVycm9ycykgdGhpcy5lbWl0dGVyLmVtaXQoJ2Vycm9yJywgYXJnLmxpbmUgKyBFT0wpXG4gICAgICB9XG4gICAgfSlcblxuICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLnN0ZG91dFxuICAgIGNvbnN0IGVyciA9IHJlc3BvbnNlLnN0ZGVyclxuXG4gICAgaWYgKHRhaWwpIHJlc3VsdC5wdXNoKHRhaWwpXG5cbiAgICBpZiAoZW1pdEVycm9ycyAmJiBlcnIubGVuZ3RoKSB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3ItY29tcGxldGVkJywgZXJyLmpvaW4oRU9MKSlcblxuICAgIGlmIChlbWl0U3RhdHVzQ2hhbmdlcykge1xuICAgICAgYXdhaXQgdGhpcy5lbWl0U3RhdHVzQ2hhbmdlcyhcbiAgICAgICAgcHJvbXB0LFxuICAgICAgICByZXN1bHQuam9pbihFT0wpLFxuICAgICAgICBlbWl0SGlzdG9yeUxlbmd0aCxcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdC5qb2luKEVPTClcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaW5pdChnaGNpQ29tbWFuZCA9ICdnaGNpJywgZ2hjaUFyZ3M6IHN0cmluZ1tdID0gW10sIGJ1ZmZlclBhdGg/OiBzdHJpbmcpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbnVsbC1rZXl3b3JkXG4gICAgY29uc3QgY3dkID0gKGF3YWl0IGFodS5nZXRSb290RGlyKGJ1ZmZlclBhdGggfHwgbnVsbCkpLmdldFBhdGgoKVxuICAgIHRoaXMucHJvY2VzcyA9IG5ldyBJbnRlcmFjdGl2ZVByb2Nlc3MoXG4gICAgICBnaGNpQ29tbWFuZCwgZ2hjaUFyZ3MsXG4gICAgICAoKSA9PiB7IHRoaXMuZW1pdHRlci5lbWl0KCdkZWJ1Zy1maW5pc2hlZCcsIHVuZGVmaW5lZCkgfSxcbiAgICAgIHsgY3dkLCBzaGVsbDogdHJ1ZSB9LFxuICAgICAgL14oLiopI35JREVIQVNLRUxMUkVQTH4oLiopfiMkLyxcbiAgICApXG5cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzLnJlcXVlc3QoXG4gICAgICBgOnNldCBwcm9tcHQyIFxcXCJcXFwiJHtFT0x9YCArXG4gICAgICBgOnNldCBwcm9tcHQtY29udCBcXFwiXFxcIiR7RU9MfWAgK1xuICAgICAgYDpzZXQgcHJvbXB0IFxcXCIjfklERUhBU0tFTExSRVBMfiVzfiNcXFxcblxcXCIke0VPTH1gLFxuICAgICAgKGFyZykgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dG90YWxpdHktY2hlY2tcbiAgICAgICAgaWYgKGFyZy50eXBlID09PSAnc3Rkb3V0Jykge1xuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdjb25zb2xlLW91dHB1dCcsIGFyZy5saW5lICsgRU9MKVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dG90YWxpdHktY2hlY2tcbiAgICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gJ3N0ZGVycicpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCBhcmcubGluZSArIEVPTClcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRvdGFsaXR5LWNoZWNrXG4gICAgICAgIH0gZWxzZSBpZiAoYXJnLnR5cGUgPT09ICdwcm9tcHQnKSB7XG4gICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2NvbnNvbGUtb3V0cHV0JywgYCR7YXJnLnByb21wdFsxXX0ke2FyZy5wcm9tcHRbMl19PiBgKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVhZHlFdmVudCgpIHtcbiAgICB0aGlzLmVtaXR0ZXIub24oJ3BhdXNlZC1vbi1leGNlcHRpb24nLCAoKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgncmVhZHknLCB1bmRlZmluZWQpKVxuICAgIHRoaXMuZW1pdHRlci5vbignbGluZS1jaGFuZ2VkJywgKCkgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ3JlYWR5JywgdW5kZWZpbmVkKSlcbiAgICB0aGlzLmVtaXR0ZXIub24oJ2RlYnVnLWZpbmlzaGVkJywgKCkgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ3JlYWR5JywgdW5kZWZpbmVkKSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QmluZGluZ3MoKSB7XG4gICAgY29uc3Qgb3V0cHV0U3RyID0gYXdhaXQgdGhpcy5ydW4oJzpzaG93IGJpbmRpbmdzJywgZmFsc2UsIGZhbHNlLCBmYWxzZSlcbiAgICByZXR1cm4gb3V0cHV0U3RyLnNwbGl0KG9zLkVPTClcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0SGlzdG9yeUxlbmd0aCgpIHtcbiAgICBjb25zdCBoaXN0b3J5UXVlcnkgPSBhd2FpdCB0aGlzLnJ1bignOmhpc3RvcnkgMTAwJywgZmFsc2UsIGZhbHNlLCBmYWxzZSlcbiAgICBjb25zdCByZWdleCA9IC8tKFxcZCopLiooPzpcXG58XFxyfFxcclxcbik8ZW5kIG9mIGhpc3Rvcnk+JC9cblxuICAgIGNvbnN0IG1hdGNoUmVzdWx0ID0gaGlzdG9yeVF1ZXJ5Lm1hdGNoKHJlZ2V4KVxuICAgIGlmICghbWF0Y2hSZXN1bHQpIHtcbiAgICAgIGlmIChoaXN0b3J5UXVlcnkuc2xpY2UoLTMpID09PSAnLi4uJykge1xuICAgICAgICByZXR1cm4gSW5maW5pdHkgLy8gaGlzdG9yeSBpcyB2ZXJ5IGxvbmdcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBwYXJzZUludChtYXRjaFJlc3VsdFsxXSwgMTApXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVByb21wdChzdGRPdXRwdXQ6IHN0cmluZyk6IEJyZWFrSW5mbyB8IFN5bWJvbCB7XG4gICAgY29uc3QgcGF0dGVybnMgPSBbe1xuICAgICAgcGF0dGVybjogL15cXFsoPzpbLVxcZF0qOiApPyguKik6XFwoKFxcZCspLChcXGQrKVxcKS1cXCgoXFxkKyksKFxcZCspXFwpLipcXF0uKiQvLFxuICAgICAgZnVuYzogKG1hdGNoKSA9PiAoe1xuICAgICAgICBmaWxlbmFtZTogbWF0Y2hbMV0sXG4gICAgICAgIHJhbmdlOiBbW3BhcnNlSW50KG1hdGNoWzJdLCAxMCkgLSAxLCBwYXJzZUludChtYXRjaFszXSwgMTApIC0gMV0sXG4gICAgICAgIFtwYXJzZUludChtYXRjaFs0XSwgMTApLCBwYXJzZUludChtYXRjaFs1XSwgMTApXV0sXG4gICAgICB9KSxcbiAgICB9LCB7XG4gICAgICBwYXR0ZXJuOiAvXlxcWyg/OlstXFxkXSo6ICk/KC4qKTooXFxkKik6KFxcZCopLShcXGQqKVxcXS4qJC8sXG4gICAgICBmdW5jOiAobWF0Y2gpID0+ICh7XG4gICAgICAgIGZpbGVuYW1lOiBtYXRjaFsxXSxcbiAgICAgICAgcmFuZ2U6IFtbcGFyc2VJbnQobWF0Y2hbMl0sIDEwKSAtIDEsIHBhcnNlSW50KG1hdGNoWzNdLCAxMCkgLSAxXSxcbiAgICAgICAgW3BhcnNlSW50KG1hdGNoWzJdLCAxMCkgLSAxLCBwYXJzZUludChtYXRjaFs0XSwgMTApXV0sXG4gICAgICB9KSxcbiAgICB9LCB7XG4gICAgICBwYXR0ZXJuOiAvXlxcWzxleGNlcHRpb24gdGhyb3duPlxcXS4qJC8sXG4gICAgICBmdW5jOiAoKSA9PiBHSENJRGVidWcucGF1c2VkT25FcnJvcixcbiAgICB9LCB7XG4gICAgICBwYXR0ZXJuOiAvXi4qJC8sXG4gICAgICBmdW5jOiAoKSA9PiBHSENJRGVidWcuZmluaXNoZWREZWJ1Z2dpbmcsXG4gICAgfV0gYXMgQXJyYXk8eyBwYXR0ZXJuOiBSZWdFeHA7IGZ1bmM6IChtYXRjaDogc3RyaW5nW10pID0+IEJyZWFrSW5mbyB8IFN5bWJvbCB9PlxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICAgICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBzdGRPdXRwdXQubWF0Y2gocGF0dGVybi5wYXR0ZXJuKVxuICAgICAgaWYgKG1hdGNoUmVzdWx0KSB7XG4gICAgICAgIHJldHVybiBwYXR0ZXJuLmZ1bmMobWF0Y2hSZXN1bHQpXG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlYWQgcHJvbXB0OiBcXG4nICsgc3RkT3V0cHV0KVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbWl0U3RhdHVzQ2hhbmdlcyhwcm9tcHQ6IHN0cmluZywgbWFpbkJvZHk6IHN0cmluZywgZW1pdEhpc3RvcnlMZW5ndGg6IGJvb2xlYW4pIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBhcnNlUHJvbXB0KHByb21wdClcblxuICAgIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5wYXVzZWRPbkVycm9yKSB7XG4gICAgICBjb25zdCBoaXN0b3J5TGVuZ3RoID0gYXdhaXQgdGhpcy5nZXRIaXN0b3J5TGVuZ3RoKClcblxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3BhdXNlZC1vbi1leGNlcHRpb24nLCB7XG4gICAgICAgIGhpc3RvcnlMZW5ndGgsXG4gICAgICAgIGxvY2FsQmluZGluZ3M6IG1haW5Cb2R5LnNwbGl0KCdcXG4nKS5zbGljZSgxKSxcbiAgICAgIH0pXG4gICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5maW5pc2hlZERlYnVnZ2luZykge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RlYnVnLWZpbmlzaGVkJywgdW5kZWZpbmVkKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBicmVha0luZm8gPSByZXN1bHQgYXMgQnJlYWtJbmZvXG5cbiAgICAgIGJyZWFrSW5mby5sb2NhbEJpbmRpbmdzID0gYXdhaXQgdGhpcy5nZXRCaW5kaW5ncygpXG5cbiAgICAgIGlmIChlbWl0SGlzdG9yeUxlbmd0aCkge1xuICAgICAgICBicmVha0luZm8uaGlzdG9yeUxlbmd0aCA9IGF3YWl0IHRoaXMuZ2V0SGlzdG9yeUxlbmd0aCgpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdsaW5lLWNoYW5nZWQnLCBicmVha0luZm8pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBtb2R1bGVOYW1lRnJvbUZpbGVQYXRoKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGNhY2hlZE1vZHVsZU5hbWUgPSB0aGlzLm1vZHVsZU5hbWVCeVBhdGguZ2V0KGZpbGVQYXRoKVxuICAgIGlmIChjYWNoZWRNb2R1bGVOYW1lKSByZXR1cm4gY2FjaGVkTW9kdWxlTmFtZVxuICAgIGNvbnN0IG1vZHVsZXMgPSAoYXdhaXQgdGhpcy5ydW4oJzpzaG93IG1vZHVsZXMnKSkuc3BsaXQob3MuRU9MKVxuICAgIGNvbnN0IHJlZ2V4ID0gL14oW14gXSspICtcXCggKyguKyksICtcXHcrICtcXCkkL1xuICAgIGZvciAoY29uc3QgbW9kdWxlU3RyIG9mIG1vZHVsZXMpIHtcbiAgICAgIGNvbnN0IG1hdGNoUmVzdWx0ID0gcmVnZXguZXhlYyhtb2R1bGVTdHIpXG4gICAgICBpZiAobWF0Y2hSZXN1bHQpIHtcbiAgICAgICAgdGhpcy5tb2R1bGVOYW1lQnlQYXRoLnNldChtYXRjaFJlc3VsdFsyXSwgbWF0Y2hSZXN1bHRbMV0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBVbmV4cGVjdGVkIHJlcGx5IGZyb20gR0hDSSAnOnNob3cgbW9kdWxlcyc6ICR7bW9kdWxlU3RyfWApXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IG5ld0NhY2hlZE1vZHVsZU5hbWUgPSB0aGlzLm1vZHVsZU5hbWVCeVBhdGguZ2V0KGZpbGVQYXRoKVxuICAgIGlmIChuZXdDYWNoZWRNb2R1bGVOYW1lKSB7XG4gICAgICByZXR1cm4gbmV3Q2FjaGVkTW9kdWxlTmFtZVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgbW9kdWxlIG5hbWUgZm9yICR7ZmlsZVBhdGh9YClcbiAgICB9XG4gIH1cbn1cbiJdfQ==